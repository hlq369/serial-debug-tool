<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web串口调试助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: inline-block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select, input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .danger {
            background-color: #e74c3c;
        }

        .danger:hover {
            background-color: #c0392b;
        }

        .success {
            background-color: #27ae60;
        }

        .success:hover {
            background-color: #229954;
        }

        #logContainer {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-tx {
            color: #27ae60;
        }

        .log-rx {
            color: #3498db;
        }

        .log-error {
            color: #e74c3c;
        }

        .log-system {
            color: #7f8c8d;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .send-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .send-group input {
            flex: 1;
        }

        .send-group button {
            margin: 0;
        }

        #sendContent {
            height: 80px;
            resize: vertical;
        }

        .config-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .worker-code {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Web串口调试助手</h1>
            <p>基于Web Serial API的串口调试工具</p>
        </div>

        <div class="main-content">
            <!-- 串口配置面板 -->
            <div class="panel">
                <h3>串口配置</h3>
                
                <div class="form-group">
                    <label for="portStatus">串口状态:</label>
                    <input type="text" id="portStatus" value="未连接" readonly style="color: #e74c3c;">
                </div>

                <div class="form-group">
                    <label for="baudRate">波特率:</label>
                    <select id="baudRate">
                        <option value="110">110</option>
                        <option value="300">300</option>
                        <option value="600">600</option>
                        <option value="1200">1200</option>
                        <option value="2400">2400</option>
                        <option value="4800">4800</option>
                        <option value="7200">7200</option>
                        <option value="9600" selected>9600</option>
                        <option value="14400">14400</option>
                        <option value="19200">19200</option>
                        <option value="28800">28800</option>
                        <option value="38400">38400</option>
                        <option value="56000">56000</option>
                        <option value="57600">57600</option>
                        <option value="76800">76800</option>
                        <option value="115200">115200</option>
                        <option value="230400">230400</option>
                        <option value="460800">460800</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dataBits">数据位:</label>
                    <select id="dataBits">
                        <option value="7">7</option>
                        <option value="8" selected>8</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="stopBits">停止位:</label>
                    <select id="stopBits">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="parity">校验位:</label>
                    <select id="parity">
                        <option value="none" selected>None</option>
                        <option value="even">Even</option>
                        <option value="odd">Odd</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bufferSize">缓冲区大小:</label>
                    <select id="bufferSize">
                        <option value="255">255</option>
                        <option value="512">512</option>
                        <option value="1024">1024</option>
                        <option value="2048">2048</option>
                        <option value="4096" selected>4096</option>
                        <option value="8192">8192</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="flowControl">流控制:</label>
                    <select id="flowControl">
                        <option value="none" selected>None</option>
                        <option value="hardware">Hardware</option>
                    </select>
                </div>

                <div style="margin-top: 20px;">
                    <button id="connectBtn" onclick="connectSerial()">连接串口</button>
                    <button id="disconnectBtn" onclick="disconnectSerial()" disabled class="danger">断开连接</button>
                </div>
            </div>

            <!-- 发送配置面板 -->
            <div class="panel">
                <h3>发送配置</h3>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="hexSend">
                    <label for="hexSend">HEX发送</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="addNewline">
                    <label for="addNewline">末尾加回车换行</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="loopSend">
                    <label for="loopSend">循环发送</label>
                </div>

                <div class="form-group" id="intervalGroup" style="display: none;">
                    <label for="sendInterval">发送间隔(MS):</label>
                    <input type="number" id="sendInterval" value="1000" min="100">
                </div>

                <div class="form-group">
                    <label for="timeout">分包超时(MS):</label>
                    <input type="number" id="timeout" value="50" min="10">
                </div>

                <h3 style="margin-top: 20px;">发送数据</h3>
                <textarea id="sendContent" placeholder="输入要发送的数据..."></textarea>
                
                <div style="margin-top: 10px;">
                    <button onclick="sendData()" class="success">发送</button>
                    <button onclick="clearSend()">清空</button>
                </div>

                <h3 style="margin-top: 20px;">快速发送</h3>
                <div id="quickSendGroups">
                    <div class="send-group">
                        <input type="text" placeholder="快速发送内容" class="quick-send-content">
                        <button onclick="quickSend(this)">发送</button>
                    </div>
                </div>
                <button onclick="addQuickSend()">添加分组</button>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="panel">
            <h3>串口日志</h3>
            <div style="margin-bottom: 10px;">
                <button onclick="clearLog()">清空日志</button>
                <button onclick="saveLog()">保存日志</button>
                <label style="margin-left: 20px;">
                    <input type="checkbox" id="autoScroll" checked> 自动滚动
                </label>
            </div>
            <div id="logContainer"></div>
        </div>

        <!-- 系统配置面板 -->
        <div class="panel config-section">
            <h3>系统配置 - Web Worker代码</h3>
            <p>以下代码可用于Web Worker中实现自动应答功能：</p>
            <div class="worker-code">
addEventListener('message', function ({data}) {
    if(data.type=='uart_receive')
    {
        postMessage({type:'log',data:'消息长度:'+data.data.length});
        //原文答复
        postMessage({type:'uart_send',data:data.data});
    }
})

setInterval(function(){
    //定时发送
    postMessage({type:'uart_send_txt',data:'hello world'});
},1000);
            </div>
        </div>
    </div>

    <script>
        let port = null;
        let reader = null;
        let writer = null;
        let loopSendInterval = null;
        let receiveBuffer = '';
        let timeoutTimer = null;

        // 循环发送复选框事件
        document.getElementById('loopSend').addEventListener('change', function() {
            document.getElementById('intervalGroup').style.display = this.checked ? 'block' : 'none';
        });

        // 连接串口
        async function connectSerial() {
            try {
                // 请求串口权限
                port = await navigator.serial.requestPort();
                
                // 获取配置参数
                const baudRate = parseInt(document.getElementById('baudRate').value);
                const dataBits = parseInt(document.getElementById('dataBits').value);
                const stopBits = parseInt(document.getElementById('stopBits').value);
                const parity = document.getElementById('parity').value;
                const bufferSize = parseInt(document.getElementById('bufferSize').value);
                const flowControl = document.getElementById('flowControl').value;

                // 打开串口
                await port.open({
                    baudRate: baudRate,
                    dataBits: dataBits,
                    stopBits: stopBits,
                    parity: parity,
                    bufferSize: bufferSize,
                    flowControl: flowControl
                });

                // 更新UI状态
                document.getElementById('portStatus').value = '已连接';
                document.getElementById('portStatus').style.color = '#27ae60';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                addLog('系统', '串口连接成功', 'system');

                // 开始读取数据
                startReading();

            } catch (error) {
                addLog('错误', '连接失败: ' + error.message, 'error');
                console.error('连接串口失败:', error);
            }
        }

        // 断开串口连接
        async function disconnectSerial() {
            try {
                if (reader) {
                    await reader.cancel();
                    reader = null;
                }
                if (writer) {
                    await writer.close();
                    writer = null;
                }
                if (port) {
                    await port.close();
                    port = null;
                }

                // 停止循环发送
                if (loopSendInterval) {
                    clearInterval(loopSendInterval);
                    loopSendInterval = null;
                }

                // 更新UI状态
                document.getElementById('portStatus').value = '未连接';
                document.getElementById('portStatus').style.color = '#e74c3c';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;

                addLog('系统', '串口已断开', 'system');

            } catch (error) {
                addLog('错误', '断开连接失败: ' + error.message, 'error');
                console.error('断开连接失败:', error);
            }
        }

        // 开始读取数据
        async function startReading() {
            if (!port) return;

            try {
                const decoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(decoder.writable);
                reader = decoder.readable.getReader();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    if (value) {
                        receiveData(value);
                    }
                }
            } catch (error) {
                addLog('错误', '读取数据失败: ' + error.message, 'error');
                console.error('读取数据失败:', error);
            }
        }

        // 接收数据处理
        function receiveData(data) {
            const timeout = parseInt(document.getElementById('timeout').value);
            
            // 添加到缓冲区
            receiveBuffer += data;
            
            // 清除之前的超时定时器
            if (timeoutTimer) {
                clearTimeout(timeoutTimer);
            }
            
            // 设置新的超时定时器
            timeoutTimer = setTimeout(() => {
                // 超时后处理数据
                if (receiveBuffer.length > 0) {
                    addLog('RX', receiveBuffer, 'rx');
                    receiveBuffer = '';
                }
            }, timeout);
        }

        // 发送数据
        async function sendData() {
            if (!port || !writer) {
                addLog('错误', '串口未连接', 'error');
                return;
            }

            const content = document.getElementById('sendContent').value;
            if (!content) {
                addLog('错误', '发送内容不能为空', 'error');
                return;
            }

            try {
                let dataToSend = content;
                
                // HEX发送
                if (document.getElementById('hexSend').checked) {
                    // 将十六进制字符串转换为字节数组
                    const hexArray = content.match(/.{1,2}/g) || [];
                    const bytes = new Uint8Array(hexArray.map(byte => parseInt(byte, 16)));
                    dataToSend = bytes;
                } else {
                    // 普通文本发送
                    if (document.getElementById('addNewline').checked) {
                        dataToSend += '\r\n';
                    }
                }

                // 创建写入器
                if (!writer) {
                    const encoder = new TextEncoderStream();
                    const writableStreamClosed = encoder.readable.pipeTo(port.writable);
                    writer = encoder.writable.getWriter();
                }

                // 发送数据
                if (document.getElementById('hexSend').checked) {
                    await writer.write(dataToSend);
                } else {
                    await writer.write(dataToSend);
                }

                addLog('TX', content, 'tx');

                // 循环发送
                if (document.getElementById('loopSend').checked) {
                    const interval = parseInt(document.getElementById('sendInterval').value);
                    if (loopSendInterval) {
                        clearInterval(loopSendInterval);
                    }
                    loopSendInterval = setInterval(() => {
                        sendData();
                    }, interval);
                }

            } catch (error) {
                addLog('错误', '发送失败: ' + error.message, 'error');
                console.error('发送数据失败:', error);
            }
        }

        // 快速发送
        function quickSend(button) {
            const input = button.previousElementSibling;
            const content = input.value;
            if (content) {
                document.getElementById('sendContent').value = content;
                sendData();
            }
        }

        // 添加快速发送分组
        function addQuickSend() {
            const container = document.getElementById('quickSendGroups');
            const div = document.createElement('div');
            div.className = 'send-group';
            div.innerHTML = `
                <input type="text" placeholder="快速发送内容" class="quick-send-content">
                <button onclick="quickSend(this)">发送</button>
            `;
            container.appendChild(div);
        }

        // 清空发送内容
        function clearSend() {
            document.getElementById('sendContent').value = '';
        }

        // 添加日志
        function addLog(type, content, className) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${className}`;
            logEntry.textContent = `[${timestamp}] ${type}: ${content}`;
            logContainer.appendChild(logEntry);

            // 自动滚动
            if (document.getElementById('autoScroll').checked) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // 清空日志
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // 保存日志
        function saveLog() {
            const logContent = document.getElementById('logContainer').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `串口日志_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 页面卸载时断开连接
        window.addEventListener('beforeunload', () => {
            if (port) {
                disconnectSerial();
            }
        });

        // 检查浏览器支持
        if (!navigator.serial) {
            alert('您的浏览器不支持Web Serial API，请使用Chrome 89或更高版本。');
        }
    </script>
</body>
</html>